; Screen Blood Enhanced - Stentorious

; Aux Vars
; "*ScrBld_INI"
; 0 = Visibility distance
; 1 = Heading angle
; 2 = Cooldown time
; 3 = Damage min
; 4 = Damage max
; 5 = Player POV
; 6 = Corpse

; "*ScrBld_SPL"
; 0 = Base splatter count
; 1 = Duration
; 2 = Projectile
; 3 = Melee
; 4 = Unarmed
; 5 = Limb dismembered
; 6 = Limb exploded
; 7 = Body exploded
; 8 = Restore IMOD
; 9 = Splatter size mix
; 10 = Splatter size max
; 11 = Splatter alpha mix
; 12 = Splatter alpha max

; On game load
Goo1.AuxVarSetFlt "*ScrBld_Timer" 0 0
Goo1.AuxVarSetFlt "*ScrBld_Timer" 0 1
Goo1.AuxVarSetFlt "*ScrBld_Count" 0

; Aux timer handlers
Player.SetOnTimerStopHandler 1 (CompileScript "ScreenBloodEnhanced\AuxTimer.gek") "*ScrBld_Count"
Player.SetOnTimerStopHandler 1 (CompileScript "ScreenBloodEnhanced\AuxTimer.gek") "*ScrBld_Combat"

; Clear splatter on death if 1st person only flag
SetJohnnyOnDyingEventHandler 1 (begin Function {ref rActor}
	if eval Goo1.AuxVarGetFlt "*ScrBld_INI" 5 == 1
		ClearScreenSplatter
	endif
end) 0 Player

; On game Restart
if eval Goo1.AuxVarGetFlt "*ScrBld_Init"
	return
endif
Goo1.AuxVarSetFlt "*ScrBld_Init" 1

; Check for requirements
if eval GetNVSEVersion < 6 || (GetNVSEVersion == 6 && GetNVSERevision < 4)
	MessageBoxEx "Screen Blood Enhanced missing requirement!%rInstall xNVSE 6.4.0+."
	return
endif
if GetPluginVersion "JohnnyGuitarNVSE" < 360
	MessageBoxEx "Screen Blood Enhanced missing requirement!%rInstall latest JohnnyGuitar NVSE plugin."
	return
endif
if GetPluginVersion "ShowOffNVSE Plugin" < 165
	MessageBoxEx "Screen Blood Enhanced missing requirement!%rInstall latest ShowOff NVSE plugin."
	return
endif
if GetPluginVersion "kNVSE" < 37
	MessageBoxEx "Screen Blood Enhanced missing requirement!%rInstall latest kNVSE plugin."
	return
endif

; Set default game settings
SetNumericGameSetting "iBloodSplatterMaxCount" 0
SetNumericGameSetting "fBloodSplatterMinSize" 0.12
SetNumericGameSetting "fBloodSplatterMaxSize" 0.18
SetNumericGameSetting "fBloodSplatterMinOpacity" 0.5
SetNumericGameSetting "fBloodSplatterMaxOpacity" 1.0
SetNumericGameSetting "fBloodSplatterMinOpacity2" 0.3
SetNumericGameSetting "fBloodSplatterMaxOpacity2" 0.6
SetNumericGameSetting "fBloodSplatterOpacityChance" 0.3

; Set flare traits
SetNumericGameSetting "fBloodSplatterFlareSize" ((GetINIFloat_Cached "BloodSplatter:fFlareSize" "Stentorious\ScreenBloodEnhanced.ini") * 0.0650)
SetNumericGameSetting "fBloodSplatterFlareMult" (GetINIFloat_Cached "BloodSplatter:fFlareAlpha" "Stentorious\ScreenBloodEnhanced.ini")

; Visibility settings
Goo1.AuxVarSetFlt "*ScrBld_INI" (GetMaxOf 0 ((GetINIFloat_Cached "Visibility:fDistance" "Stentorious\ScreenBloodEnhanced.ini") * 69.99104)) 0
Goo1.AuxVarSetFlt "*ScrBld_INI" (GetMaxOf 0 (GetINIFloat_Cached "Visibility:fHeadingAngle" "Stentorious\ScreenBloodEnhanced.ini")) 1
Goo1.AuxVarSetFlt "*ScrBld_INI" (GetMaxOf 0 (GetINIFloat_Cached "Visibility:fCooldown" "Stentorious\ScreenBloodEnhanced.ini")) 2
Goo1.AuxVarSetFlt "*ScrBld_INI" (GetMaxOf 0 (GetINIFloat_Cached "Visibility:fDamageMin" "Stentorious\ScreenBloodEnhanced.ini")) 3
Goo1.AuxVarSetFlt "*ScrBld_INI" (GetMaxOf (Goo1.AuxVarGetFlt "*ScrBld_INI" 3) (GetINIFloat_Cached "Visibility:fDamageMax" "Stentorious\ScreenBloodEnhanced.ini")) 4
Goo1.AuxVarSetFlt "*ScrBld_INI" (Clamp (GetINIFloat_Cached "Visibility:iPOV" "Stentorious\ScreenBloodEnhanced.ini") 0 2) 5
Goo1.AuxVarSetFlt "*ScrBld_INI" (eval GetINIFloat_Cached "Visibility:bCorpse" "Stentorious\ScreenBloodEnhanced.ini") 6
Goo1.AuxVarSetFlt "*ScrBld_INI" (eval GetINIFloat_Cached "Visibility:bRobot" "Stentorious\ScreenBloodEnhanced.ini") 7
if eval GetINIFloat_Cached "Visibility:bRequireOverlay" "Stentorious\ScreenBloodEnhanced.ini"
	Goo1.AuxVarSetFlt "*ScrBld_INI" 1 8
	SetEventHandler "OnActorUnequip" (CompileScript "ScreenBloodEnhanced\OnUnequip.gek") "first"::Player
else
	Goo1.AuxVarSetFlt "*ScrBld_INI" 0 8
endif
Goo1.AuxVarSetFlt "*ScrBld_INI" (GetMaxOf 0 (GetINIFloat_Cached "General:fAutoWipe" "Stentorious\ScreenBloodEnhanced.ini")) 9

; Splatter settings
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:iSplatterCount" "Stentorious\ScreenBloodEnhanced.ini")) 0
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fDuration" "Stentorious\ScreenBloodEnhanced.ini")) 1
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fProjectile" "Stentorious\ScreenBloodEnhanced.ini")) 2
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fMelee" "Stentorious\ScreenBloodEnhanced.ini")) 3
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fUnarmed" "Stentorious\ScreenBloodEnhanced.ini")) 4
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fLimbDismembered" "Stentorious\ScreenBloodEnhanced.ini")) 5
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fLimbExploded" "Stentorious\ScreenBloodEnhanced.ini")) 6
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fBodyExploded" "Stentorious\ScreenBloodEnhanced.ini")) 7
Goo1.AuxVarSetFlt "*ScrBld_SPL" (eval GetINIFloat_Cached "General:bRestoreIMOD" "Stentorious\ScreenBloodEnhanced.ini") 8
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fSizeMin" "Stentorious\ScreenBloodEnhanced.ini")) 9
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fSizeMax" "Stentorious\ScreenBloodEnhanced.ini")) 10
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fAlphaMin" "Stentorious\ScreenBloodEnhanced.ini")) 11
Goo1.AuxVarSetFlt "*ScrBld_SPL" (GetMaxOf 0 (GetINIFloat_Cached "BloodSplatter:fAlphaMax" "Stentorious\ScreenBloodEnhanced.ini")) 12
Goo1.AuxVarSetFlt "*ScrBld_SPL" (eval GetINIFloat_Cached "BloodSplatter:bUseBaseGameTexturePath" "Stentorious\ScreenBloodEnhanced.ini") 13

; Mod support settings
Goo1.AuxVarSetFlt "*ScrBld_MOD" (GetMaxOf 0 (GetINIFloat_Cached "ModSupport:fHelmetOverlay" "Stentorious\ScreenBloodEnhanced.ini")) 0
Goo1.AuxVarSetFlt "*ScrBld_MOD" (GetMaxOf 0 (GetINIFloat_Cached "ModSupport:fModernNightVision" "Stentorious\ScreenBloodEnhanced.ini")) 1

; Event handlers
SetOnHitEventHandler (CompileScript "ScreenBloodEnhanced\OnHit.gek") 1

; Auto wipe
if eval Goo1.AuxVarGetFlt "*ScrBld_INI" 9 > 0
	SetEventHandler "OnCombatEnd" ({ref rTarget, ref rSource} => Player.AuxTimerStart "*ScrBld_Combat" (Goo1.AuxVarGetFlt "*ScrBld_INI" 9) 14)
endif

; Keyboard
if eval (int iKeyID = GetINIFloat_Cached "General:iKeybind" "Stentorious\ScreenBloodEnhanced.ini") > 0
	SetOnKeyDownEventHandler (CompileScript "ScreenBloodEnhanced\ScreenWipe.gek") 1 iKeyID
endif

; Controller
if eval GetINIFloat_Cached "General:bControllerSupport" "Stentorious\ScreenBloodEnhanced.ini"
	SetEventHandler "OnControlDown:27" (begin function {int iKeyCode}
		if eval GetController
			DC 13
		endif
	end)
	SetEventHandler "OnControlUp:27" (begin function {int iKeyCode}
		if eval GetController
			EC 13
		endif
	end)
	SetEventHandler "OnControlDown:13" (begin function {int iKeyCode}
		if eval GetController && IsControlPressed 27
			Call (CompileScript "ScreenBloodEnhanced\ScreenWipe.gek") 0
		endif
	end)
endif

CloseFileSO "Stentorious\ScreenBloodEnhanced.ini" 0
